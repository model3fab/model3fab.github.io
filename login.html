<!DOCTYPE html>
<html>
<head>
  <title>Login</title>
  <link rel="stylesheet" href="../w3.css">
  <link rel="stylesheet" href="../family_Raleway.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <link rel="stylesheet" href="forms_style.css">
  <script type="text/javascript" src="https://npmcdn.com/parse/dist/parse.min.js"></script>
  <script type="text/javascript" type="text/javascript">
Parse.serverURL = 'https://parseapi.back4app.com';
Parse.initialize('3BvaDwQZMh46667Meslf8E2DuUWKjb5RBiAuXNxv', 'CRR8qDBiWK1UG04hyxeKIRoZKc3fh3g0nxTpXdKN');

</script>
</head>
<style>
.noDisplay {
  display: none;
}
.setDisplay {
  display: initial;
}

div.collections {
    max-width: 570px;
    margin: auto;
}
h2 {
    margin-top: 3em;
}
</style>
<body>

<!-- Navbar (sit on top) -->
<div id="navbar" class="w3-top">
  <div class="w3-bar w3-white w3-card" id="myNavbar">
    <a href="/model3fab" class="w3-bar-item w3-button w3-wide">model3fab</a>
    <span  class="w3-bar-item">Company: </span>
    <input id="companyName" class="w3-bar-item w3-border-small"/> 
    
    <!-- 
    <a id=collectionsList href='login.html' class="w3-bar-item w3-button">Collections</a>
    <a href="#" onclick="saveToDatabase()" class="w3-bar-item w3-button">Save</a>
    <a href="#renderDiv" class="w3-bar-item w3-button"><i class="fa fa-arrow-up"></i>Top</a>
    <a href="#Materials" class="w3-bar-item w3-button"><i class="fa fa-paint-brush"></i> Materials</a>
    <a href="#fileDiv" onclick="gotoObject()" class="w3-bar-item w3-button"><i class="fa fa-cube"></i> Object</a>
    -->
    <span class="w3-bar-item" style="padding-right: 0px;"><i class="fa fa-tachometer"></i></span><span  id="status" class="w3-bar-item">Status</span>
    <!-- Right-sided navbar links -->
    <div class="w3-right w3-hide-small">
      <a href="/model3fab#contact" class="w3-bar-item w3-button"><i class="fa fa-envelope"></i> Contacto</a>
      <a href="login.html" class="w3-bar-item w3-button"><i class="fa fa-user"></i> <span id="loginName"> Login</a><span>
      <a href="#" onclick="logout()" class="w3-bar-item w3-button"> <span id="logoutName"> Logout</a><span>
      <a href="/model3fab#register" class="w3-bar-item w3-button"><i class="fa fa-user-plus"></i> Registro</a>
      <!--  other icons fa-group -->
    </div>
    <!-- Hide right-floated links on small screens and replace them with a menu icon -->

    <a href="javascript:void(0)" class="w3-bar-item w3-button w3-right w3-hide-large w3-hide-medium" onclick="w3_open()">
      <i class="fa fa-bars"></i>
    </a>
  </div>
</div>


<form name="formSignUp" id="formSignUp" style="border:1px solid #ccc" class="noDisplay">
  <div class="container">
    <h1>Login in model3fab</h1>
    <hr>

    <label for="email"><b>Email</b></label>
    <input type="text" placeholder="Enter Email" name="email" autocomplete="username" value="" required>

    <label for="password"><b>Password</b></label>
    <input type="password" placeholder="Enter Password" name="password" autocomplete="current-password" value="" required>

    <div class="clearfix">
      <button type="button" onclick="validateForm()" class="signupbtn" >Login</button>
    </div>
  </div>
</form>

<div id="collections" class="collections noDisplay">
  <h2 >Collections</h2>
  <ul id="collectionsList" ></ul>
  <button onclick="createCollection()">Create New Collection</button>
</div>

<script>
function parse_query_string(query) {
  var vars = query.split("&");
  var query_string = {};
  for (var i = 0; i < vars.length; i++) {
    var pair = vars[i].split("=");
    var key = decodeURIComponent(pair[0]);
    var value = decodeURIComponent(pair[1]);
    // If first entry with this name
    if (typeof query_string[key] === "undefined") {
      query_string[key] = decodeURIComponent(value);
      // If second entry with this name
    } else if (typeof query_string[key] === "string") {
      var arr = [query_string[key], decodeURIComponent(value)];
      query_string[key] = arr;
      // If third or later entry with this name
    } else {
      query_string[key].push(decodeURIComponent(value));
    }
  }
  return query_string;
}

async function checkUser() {
    var query = window.location.search.substring(1);
    var qs = parse_query_string(query);
    var company;
    if (qs.company != null) {
        company = qs.company;
        printCollections(qs.company);
    } else {
        const result = await Parse.Cloud.run('currentUser');
        if (result == null) {
            document.getElementById("formSignUp").classList.remove("noDisplay");
        } else {
            printCollections();
        }
    }
}
checkUser();

async function validateForm() {
    if (formSignUp.email.value == "") {
        alert("The email is required!");
        return false;
    }
    if (formSignUp.password.value == "") {
        alert("The password is required!");
        return false;
    }

    params1 = {}
    params1.username = formSignUp.email.value;
    params1.password = formSignUp.password.value;
    const result = await Parse.Cloud.run('login', params1);
    console.log("login", result)
    company = result;
    if (result != null) {
        document.getElementById("loginName").innerHTML = result.username.split('@')[0]
        printCollections(result);
    }
    return true;  // don't send yet
}

async function printCollections(result) {
    const collectionsResult = await Parse.Cloud.run('readCollections');
    if (collectionsResult == null) {
        document.getElementById("formSignUp").classList.remove("noDisplay");
    } else {
        document.getElementById("loginName").innerHTML = collectionsResult.username.split('@')[0]
        document.getElementById("formSignUp").classList.add("noDisplay");
        document.getElementById("collections").classList.remove("noDisplay");
        params2 = {}
        params2.company = result;
        console.log("collectionsResult", collectionsResult.collections);
        console.log("Company name", collectionsResult.companyName);
        for (i=0; i< collectionsResult.collections.length; i++) {
            addItem(collectionsResult.collections[i].id, collectionsResult.collections[i].name);
        }
        /* readCollectionById
        params3 = {}
        params3.id = collectionsResult[0].id;
        const objectCollection = await Parse.Cloud.run('readCollectionById', params3);
        console.log("objectCollection", objectCollection);
        */
    }
}

function addItem(id, name) {
            //document.write(collectionsResult[i].id + " " + collectionsResult[i].name + "<BR>");
            var li = document.createElement('LI');
            var a = document.createElement('a');
            var linkText = document.createTextNode(name);
            a.appendChild(linkText);
            a.title = name;
            a.href = "collection.html?collection=" + id;
            document.getElementById("collectionsList").appendChild(li);
            li.appendChild(a);
}

content={"materialArr":[{"name":"default","color_r":0.45,"color_g":0.72,"color_b":0.96,"emissive_r":0.33,"emissive_g":0.51,"emissive_b":0.66,"roughness":0.109,"metalness":0.35,"reflectivity":0.18,"clearcoat":0,"clearcoatRoughness":0,"transparent":true,"opacity":0.78,"diffuseMap":false,"normalFactor":1,"envMapIntensity":0.94,"ior":1.16,"wireframe":false},{"name":"ground","size_x":"0.001","size_y":"0.001","texture":"textures/uv_grid_opengl.jpg","color_r":"0.5","color_g":"0.5","color_b":"0.5","diffuseMap":false},{"name":"background","color_r":0.6,"color_g":0.6,"color_b":0.6,"diffuseMap":true},{"name":"UV_map","texture":"textures/uv_grid_opengl.jpg","diffuseMap":true}],"designArr":{"First Object":{"name":"First Object","parameters":[],"pieces":[]}}}

async function createCollection() {
    name = "collection "+ (document.getElementById("collectionsList").childElementCount + 1.0);
    params1 = {}
    params1.company  = company;
    params1.collectionName = name;
    params1.collectionData = JSON.stringify(content);
    const result = await Parse.Cloud.run('createCollection', params1);
    console.log("company created ", result);
    addItem(company, name);
}

async function logout() {
    const result = await Parse.Cloud.run('logout');
    console.log("logout", result);
    window.location.href = "login.html";
 }
</script>

</body>
</html>
